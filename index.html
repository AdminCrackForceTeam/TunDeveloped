<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tun Media - Shop Uy Tín</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;800;900&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0f0f0f;
    color: #e2e8f0;
    min-height: 100vh;
    background: linear-gradient(135deg, #1a0000 0%, #300000 100%);
  }

  .top {
    height: 70px;
    background: rgba(30, 0, 0, 0.92);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    border-bottom: 1px solid rgba(239, 68, 68, 0.4);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 2.4rem;
    font-weight: 900;
    letter-spacing: -1px;
    background: linear-gradient(90deg, #ff2d55, #ff6b6b, #ff9f9f, #ff2d55);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 20px rgba(255, 45, 85, 0.7);
  }

  .top-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .top-right button, .top-right .admin-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 3px 10px rgba(239, 68, 68, 0.4);
  }

  .top-right button:hover, .top-right .admin-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 20px rgba(239, 68, 68, 0.6);
    background: linear-gradient(135deg, #f87171, #ef4444);
  }

  .wrap {
    max-width: 1440px;
    margin: 40px auto;
    padding: 0 25px;
    display: flex;
    gap: 35px;
  }

  /* === SỬA MENU SIDEBAR - LÀM NỔI BẬT HƠN === */
  .sidebar {
    width: 280px;
    background: linear-gradient(135deg, rgba(40, 0, 0, 0.92), rgba(60, 0, 0, 0.85));
    backdrop-filter: blur(16px);
    border-radius: 24px;
    padding: 35px 20px;
    border: 2px solid rgba(239, 68, 68, 0.5);
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.25);
    height: fit-content;
  }

  .sidebar h3 {
    color: #ff6b6b;
    font-size: 1.25rem;
    font-weight: 900;
    margin-bottom: 28px;
    text-transform: uppercase;
    letter-spacing: 2.2px;
    text-shadow: 0 0 10px rgba(255, 107, 107, 0.6);
    text-align: center;
  }

  .sidebar a {
    display: flex;
    align-items: center;
    padding: 18px 24px;
    border-radius: 16px;
    margin-bottom: 14px;
    color: #ff9f9f;
    font-weight: 700;
    font-size: 1.1rem;
    transition: all 0.35s ease;
    background: rgba(239, 68, 68, 0.08);
    border: 1px solid rgba(239, 68, 68, 0.15);
    position: relative;
    overflow: hidden;
  }

  .sidebar a::before {
    content: '';
    position: absolute;
    inset: 0;
    background: linear-gradient(90deg, transparent, rgba(239, 68, 68, 0.25), transparent);
    transform: translateX(-100%);
    transition: transform 0.6s;
  }

  .sidebar a:hover::before {
    transform: translateX(100%);
  }

  .sidebar a:hover {
    color: white;
    background: rgba(239, 68, 68, 0.25);
    border-color: #ef4444;
    transform: translateX(6px) scale(1.03);
    box-shadow: 0 8px 25px rgba(239, 68, 68, 0.35);
  }

  /* === SỬA PHẦN THÔNG BÁO - NỔI BẬT HƠN === */
  .notice {
    background: linear-gradient(135deg, rgba(40, 0, 0, 0.85), rgba(60, 0, 0, 0.75));
    border: 2px solid #ef4444;
    border-radius: 16px;
    padding: 22px 28px;
    margin-bottom: 40px;
    font-size: 1.15rem;
    font-weight: 600;
    color: #fecaca;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(239, 68, 68, 0.3);
    position: relative;
    overflow: hidden;
  }

  .notice::before {
    content: '⚡';
    position: absolute;
    top: 50%;
    left: 20px;
    transform: translateY(-50%);
    font-size: 2.2rem;
    opacity: 0.4;
  }

  /* === PHẦN GIẢM GIÁ === */
  .discount-box {
    background: rgba(20, 0, 0, 0.78);
    border-radius: 16px;
    padding: 24px;
    margin: 20px 0;
    border: 1px solid rgba(239, 68, 68, 0.3);
  }

  .discount-box input {
    width: 100%;
    padding: 14px 18px;
    font-size: 1.1rem;
    margin-bottom: 12px;
  }

  /* Các style còn lại giữ nguyên */
  .content { flex: 1; min-width: 340px; }

  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 28px;
  }

  .card {
    background: rgba(20, 0, 0, 0.78);
    border-radius: 20px;
    padding: 28px;
    border: 1px solid rgba(239, 68, 68, 0.25);
    transition: all 0.4s ease;
    backdrop-filter: blur(10px);
  }

  .card:hover {
    transform: translateY(-16px);
    box-shadow: 0 28px 60px -14px rgba(239, 68, 68, 0.4);
    border-color: #ef4444;
  }

  .card h4 {
    color: #fecaca;
    font-size: 1.45rem;
    margin-bottom: 12px;
  }

  .price {
    color: #fbbf24;
    font-size: 1.8rem;
    font-weight: 800;
    margin: 14px 0 10px;
  }

  .sold {
    color: #34d399;
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 18px;
  }

  .buy {
    background: linear-gradient(135deg, #ef4444, #b91c1c);
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: center;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 16px rgba(239, 68, 68, 0.4);
    border: 2px solid transparent;
  }

  .buy:hover {
    background: linear-gradient(135deg, #f87171, #ef4444);
    transform: translateY(-3px) scale(1.04);
    box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
  }

  /* ... (giữ nguyên các style modal, button, input, etc...) */
</style>
</head>
<body>

<!-- ... (giữ nguyên loadingOverlay, top bar) ... -->

<div class="wrap">
  <div class="sidebar">
    <h3>MENU CHÍNH</h3>
    <a onclick="view='shop';render()">Cửa hàng</a>
    <a onclick="view='nap';render()">Nạp tiền</a>
    <a onclick="view='orders';render()">Lịch sử mua</a>
  </div>
  <div class="content" id="content"></div>
</div>

<!-- Modal Đăng nhập, Đăng ký, Admin giữ nguyên -->

<!-- Modal Admin (thêm phần mã giảm giá) -->
<div class="modal hidden" id="adminModal">
  <div class="box">
    <h3>Admin Panel</h3>

    <!-- ... (giữ nguyên các phần Quản lý người dùng, Duyệt đơn, Quản lý sản phẩm, Thông báo, QR) ... -->

    <!-- === PHẦN MỚI: QUẢN LÝ MÃ GIẢM GIÁ === -->
    <div class="box">
      <h4 style="color:#fecaca;">Quản lý mã giảm giá</h4>
      <div id="discountList"></div>
      
      <h4 style="color:#fecaca;margin-top:35px;">Tạo mã giảm giá mới</h4>
      <input id="newDiscountCode" placeholder="Mã giảm giá (ví dụ: SALE30)">
      <input id="newDiscountPercent" type="number" placeholder="Phần trăm giảm (1-100)" min="1" max="100">
      <input id="newDiscountMax" type="number" placeholder="Số lần dùng tối đa (để trống = không giới hạn)">
      <button class="action-btn" onclick="addNewDiscount()">Tạo Mã</button>
    </div>

    <button class="action-btn" style="background:#4b5563;margin-top:40px;width:100%;font-size:1.3rem;" onclick="closeAdmin()">Đóng</button>
  </div>
</div>

<script>
// ================== BIẾN MỚI CHO GIẢM GIÁ ==================
let discounts = JSON.parse(storage.getItem("discounts") || "[]"); // [{code, percent, maxUses, usedCount}]

// Thêm vào saveAll()
function saveAll() {
  storage.setItem("users", JSON.stringify(users));
  storage.setItem("products", JSON.stringify(products));
  storage.setItem("notice", notice);
  storage.setItem("qr", qr);
  storage.setItem("qrNote", qrNote);
  storage.setItem("discounts", JSON.stringify(discounts)); // <--- thêm
  if (currentUser) {
    storage.setItem("currentUser", JSON.stringify(currentUser));
  }
}

// ================== RENDER - THÊM INPUT MÃ GIẢM GIÁ VÀO SHOP ==================
function render() {
  // ... (giữ nguyên phần top-right, notice, products) ...

  if(view === "shop") {
    // ... (giữ nguyên logic random sold) ...

    let discountInputHtml = currentUser ? `
      <div class="discount-box">
        <h4 style="color:#fbbf24;margin-bottom:12px;">Áp dụng mã giảm giá</h4>
        <input id="discountCodeInput" placeholder="Nhập mã giảm giá" style="margin-bottom:12px;">
        <button class="action-btn" style="width:100%;padding:14px;" onclick="applyDiscount()">Áp dụng</button>
        <div id="discountMessage" style="margin-top:12px;color:#34d399;font-weight:600;"></div>
      </div>
    ` : '';

    content.innerHTML = `
      <div class="notice">${notice}</div>
      ${discountInputHtml}
      <div class="products">
        ${products.length ? products.map((p,i)=>`
          <div class="card">
            <h4>${p.name}</h4>
            <div style="color:#fda4af;margin:10px 0;">${p.desc || ''}</div>
            <div class="price">${Number(p.price || 0).toLocaleString('vi-VN')}đ</div>
            <div class="sold">Đã có <strong>${Number(p.sold || 0).toLocaleString('vi-VN')}</strong> người mua</div>
            <div class="buy" onclick="buy(${i})">MUA NGAY</div>
          </div>
        `).join("") : "<div style='text-align:center;padding:100px 0;color:#fda4af;font-size:1.3rem;'>Chưa có sản phẩm</div>"}
      </div>`;
  }

  // ... (giữ nguyên các view khác: nap, orders) ...
}

// ================== HÀM ÁP DỤNG MÃ GIẢM GIÁ ==================
let currentDiscount = null; // {code, percent}

function applyDiscount() {
  const codeInput = document.getElementById("discountCodeInput");
  const code = codeInput.value.trim().toUpperCase();
  const msg = document.getElementById("discountMessage");

  if (!code) {
    msg.style.color = "#fda4af";
    msg.textContent = "Vui lòng nhập mã!";
    currentDiscount = null;
    return;
  }

  const disc = discounts.find(d => d.code === code);
  if (!disc) {
    msg.style.color = "#ef4444";
    msg.textContent = "Mã không hợp lệ!";
    currentDiscount = null;
    return;
  }

  if (disc.maxUses && (disc.usedCount || 0) >= disc.maxUses) {
    msg.style.color = "#ef4444";
    msg.textContent = "Mã đã hết lượt sử dụng!";
    currentDiscount = null;
    return;
  }

  currentDiscount = {code: disc.code, percent: disc.percent};
  msg.style.color = "#34d399";
  msg.textContent = `Áp dụng thành công! Giảm ${disc.percent}% cho đơn hàng tiếp theo`;
}

// Sửa lại hàm buy để hỗ trợ giảm giá
function buy(index) {
  if (!currentUser) return alert("Vui lòng đăng nhập để mua!");

  const product = products[index];
  if (!product) return alert("Sản phẩm không tồn tại!");

  let finalPrice = product.price;
  let discountText = "";

  if (currentDiscount) {
    finalPrice = product.price * (1 - currentDiscount.percent / 100);
    discountText = ` (giảm ${currentDiscount.percent}%)`;
  }

  if (currentUser.balance < finalPrice) return alert("Không đủ tiền! Vui lòng nạp thêm.");

  if (confirm(`Mua "${product.name}" với giá ${Number(finalPrice).toLocaleString('vi-VN')}đ${discountText} ?`)) {
    showLoading();
    setTimeout(() => {
      currentUser.balance -= finalPrice;
      product.sold = (product.sold || 0) + 1;

      // Ghi nhận sử dụng mã giảm giá
      if (currentDiscount) {
        const disc = discounts.find(d => d.code === currentDiscount.code);
        if (disc) {
          disc.usedCount = (disc.usedCount || 0) + 1;
        }
        currentDiscount = null; // reset sau khi dùng
        document.getElementById("discountMessage").textContent = "";
      }

      currentUser.orders = currentUser.orders || [];
      currentUser.orders.push({
        productName: product.name,
        date: new Date().toLocaleString('vi-VN'),
        status: 'pending',
        finalPrice: finalPrice // lưu giá cuối đã giảm (nếu có)
      });

      const userIndex = users.findIndex(u => u.u === currentUser.u);
      if (userIndex !== -1) users[userIndex] = {...currentUser};

      saveAll();
      render();
      hideLoading();
      alert("Đơn hàng đã được tạo! Chờ admin duyệt.");
    }, 700);
  }
}

// ================== ADMIN - QUẢN LÝ MÃ GIẢM GIÁ ==================
function renderDiscountList() {
  const container = document.getElementById("discountList");
  let html = "";

  discounts.forEach((d, i) => {
    html += `
      <div class="user-list-item">
        <div>
          <strong style="color:#fecaca;font-size:1.25rem;">${d.code}</strong><br>
          <span style="color:#fda4af;">Giảm ${d.percent}% • Đã dùng: ${d.usedCount || 0}/${d.maxUses || '∞'}</span>
        </div>
        <button class="delete-btn" onclick="deleteDiscount(${i})">Xóa</button>
      </div>
    `;
  });

  container.innerHTML = html || "<p style='text-align:center;color:#fda4af;padding:20px;'>Chưa có mã giảm giá nào</p>";
}

function addNewDiscount() {
  const code = document.getElementById("newDiscountCode").value.trim().toUpperCase();
  const percent = Number(document.getElementById("newDiscountPercent").value);
  const maxUses = Number(document.getElementById("newDiscountMax").value) || null;

  if (!code) return alert("Nhập mã giảm giá!");
  if (isNaN(percent) || percent <= 0 || percent > 100) return alert("Phần trăm giảm phải từ 1-100!");
  if (discounts.some(d => d.code === code)) return alert("Mã này đã tồn tại!");

  showLoading();
  setTimeout(() => {
    discounts.push({
      code,
      percent,
      maxUses,
      usedCount: 0
    });
    saveAll();
    document.getElementById("newDiscountCode").value = "";
    document.getElementById("newDiscountPercent").value = "";
    document.getElementById("newDiscountMax").value = "";
    renderDiscountList();
    hideLoading();
    alert("Đã tạo mã giảm giá mới!");
  }, 700);
}

function deleteDiscount(index) {
  if (!confirm("Xóa mã giảm giá này?")) return;
  showLoading();
  setTimeout(() => {
    discounts.splice(index, 1);
    saveAll();
    renderDiscountList();
    hideLoading();
  }, 600);
}

// Sửa openAdminPanel để render thêm danh sách mã giảm giá
function openAdminPanel() {
  const pass = prompt("Nhập mật khẩu Admin:");
  if (pass !== ADMIN_PASSWORD) {
    if (pass !== null) alert("Mật khẩu sai!");
    return;
  }

  document.getElementById("adminModal").classList.remove("hidden");
  document.getElementById("n").value = notice;
  document.getElementById("qn").value = qrNote;
  document.getElementById("qrPreview").src = qr;
  renderUserList();
  renderPendingOrders();
  renderProductList();
  renderDiscountList(); // <--- thêm
}

// ... (giữ nguyên toàn bộ code còn lại: auth, buy cũ, admin functions, v.v.) ...
</script>
</body>
</html>