<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>Tun Media - Shop Uy Tín</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Orbitron:wght@700;800;900&family=Poppins:wght@700;800&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0f0f0f;
    color: #e2e8f0;
    min-height: 100vh;
    background: linear-gradient(135deg, #000000 0%, #ff0000 50%, #000000 100%);
  }

  .top {
    height: 70px;
    background: rgba(30, 0, 0, 0.92);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    border-bottom: 1px solid rgba(255, 0, 0, 0.6);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    font-family: 'Orbitron', sans-serif;
    font-size: 1.8rem;
    font-weight: 900;
    letter-spacing: -0.5px;
    display: flex;
    flex-direction: column;
    align-items: center;
    line-height: 1;
    background: linear-gradient(90deg, #ff0000, #ff4d4d, #ff9999, #ff0000);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    text-shadow: 0 0 25px rgba(255, 0, 0, 0.8);
    animation: glow 1.5s ease-in-out infinite alternate;
  }

  .logo span:first-child {
    font-size: 2.2rem;
  }

  .logo span:last-child {
    font-size: 1.4rem;
  }

  @keyframes glow {
    from { text-shadow: 0 0 15px rgba(255, 0, 0, 0.6); }
    to { text-shadow: 0 0 40px rgba(255, 0, 0, 1); }
  }

  .top-right {
    display: flex;
    align-items: center;
    gap: 12px;
  }

  .top-right button, .top-right .admin-btn {
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: white;
    border: none;
    padding: 8px 16px;
    border-radius: 8px;
    font-weight: 700;
    font-size: 0.95rem;
    cursor: pointer;
    transition: all 0.25s ease;
    box-shadow: 0 3px 10px rgba(255, 0, 0, 0.5), 0 0 15px rgba(255, 0, 0, 0.3);
    position: relative;
    overflow: hidden;
  }

  .top-right button::before, .top-right .admin-btn::before {
    content: '';
    position: absolute;
    top: -50%;
    left: -50%;
    width: 200%;
    height: 200%;
    background: radial-gradient(circle, rgba(255,255,255,0.25) 0%, transparent 70%);
    opacity: 0;
    transition: all 0.5s;
  }

  .top-right button:hover::before, .top-right .admin-btn:hover::before {
    opacity: 1;
    top: 0;
    left: 0;
  }

  .top-right button:hover, .top-right .admin-btn:hover {
    transform: translateY(-2px) scale(1.05);
    box-shadow: 0 8px 20px rgba(255, 0, 0, 0.7), 0 0 40px rgba(255, 0, 0, 1);
    background: linear-gradient(135deg, #ff4d4d, #ff0000);
  }

  .wrap {
    max-width: 1440px;
    margin: 40px auto;
    padding: 0 25px;
    display: flex;
    gap: 35px;
  }

  .sidebar {
    width: 280px;
    background: linear-gradient(180deg, rgba(30, 0, 0, 0.85) 0%, rgba(255, 0, 0, 0.15) 100%);
    backdrop-filter: blur(12px);
    border-radius: 20px;
    padding: 30px 20px;
    border: 1px solid rgba(255, 0, 0, 0.4);
    height: fit-content;
    box-shadow: 0 0 30px rgba(255, 0, 0, 0.4);
  }

  .sidebar h3 {
    color: #ff4d4d;
    font-size: 1.1rem;
    font-weight: 800;
    margin-bottom: 24px;
    text-transform: uppercase;
    letter-spacing: 2px;
    text-shadow: 0 0 8px rgba(255, 77, 77, 0.6);
  }

  .sidebar a {
    display: flex;
    align-items: center;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 10px;
    color: #ff9999;
    font-weight: 600;
    font-size: 1.05rem;
    transition: all 0.3s;
    cursor: pointer;
    position: relative;
    overflow: hidden;
    text-decoration: none;
    box-shadow: inset 0 0 15px rgba(255, 0, 0, 0.2);
    background: rgba(255, 0, 0, 0.05);
  }

  .sidebar a::before {
    content: '';
    position: absolute;
    top: 0;
    left: -100%;
    width: 100%;
    height: 100%;
    background: linear-gradient(90deg, transparent, rgba(255, 0, 0, 0.4), transparent);
    transition: all 0.5s;
  }

  .sidebar a:hover::before {
    left: 100%;
  }

  .sidebar a:hover {
    background: rgba(255, 0, 0, 0.25);
    color: #ffffff;
    transform: translateX(8px) scale(1.05);
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.6), inset 0 0 25px rgba(255, 0, 0, 0.4);
  }

  .sidebar a i {
    margin-right: 12px;
    font-size: 1.2rem;
    color: #ff0000;
    transition: transform 0.3s, color 0.3s;
  }

  .sidebar a:hover i {
    transform: rotate(360deg);
    color: #fff;
  }

  .content { flex: 1; min-width: 340px; }

  .notice {
    background: rgba(30, 0, 0, 0.65);
    border-left: 6px solid #ff0000;
    padding: 18px 24px;
    border-radius: 14px;
    margin-bottom: 35px;
    font-size: 1.05rem;
    backdrop-filter: blur(8px);
    box-shadow: 0 4px 15px rgba(255, 0, 0, 0.3);
  }

  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
    gap: 28px;
  }

  .card {
    background: linear-gradient(180deg, rgba(20, 0, 0, 0.78) 0%, rgba(255, 0, 0, 0.1) 100%);
    border-radius: 20px;
    padding: 28px;
    border: 1px solid rgba(255, 0, 0, 0.35);
    transition: all 0.4s ease;
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 20px rgba(0,0,0,0.5), 0 0 20px rgba(255, 0, 0, 0.3);
  }

  .card:hover {
    transform: translateY(-16px);
    box-shadow: 0 28px 60px -14px rgba(255, 0, 0, 0.5), 0 0 50px rgba(255, 0, 0, 0.7);
    border-color: #ff0000;
  }

  .card h4 {
    color: #ff9999;
    font-size: 1.45rem;
    margin-bottom: 12px;
    text-shadow: 0 0 6px rgba(255, 153, 153, 0.4);
  }

  .price {
    color: #ffcc00;
    font-size: 1.8rem;
    font-weight: 800;
    margin: 14px 0 10px;
    text-shadow: 0 0 12px rgba(255, 204, 0, 0.6);
  }

  .sold {
    color: #00ff99;
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 8px;
  }

  .inventory {
    color: #99ccff;
    font-size: 1.05rem;
    font-weight: 600;
    margin-bottom: 18px;
  }

  .buy {
    background: linear-gradient(135deg, #ff0000, #990000);
    color: white;
    font-weight: 700;
    font-size: 1.1rem;
    text-align: center;
    padding: 16px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 16px rgba(255, 0, 0, 0.5), 0 0 25px rgba(255, 0, 0, 0.4);
    border: 2px solid transparent;
    position: relative;
    overflow: hidden;
    text-shadow: 0 0 5px rgba(0,0,0,0.6);
  }

  .buy::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.25);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  .buy:hover::before {
    width: 300px;
    height: 300px;
  }

  .buy:hover {
    background: linear-gradient(135deg, #ff4d4d, #ff0000);
    transform: translateY(-3px) scale(1.04);
    box-shadow: 0 12px 30px rgba(255, 0, 0, 0.7), 0 0 50px rgba(255, 0, 0, 1);
  }

  .buy:active {
    border: 2px solid #ff0000;
    box-shadow: 0 0 15px rgba(255, 0, 0, 0.9), inset 0 0 25px rgba(255, 0, 0, 0.6);
    transform: translateY(0) scale(1);
  }

  .box {
    background: linear-gradient(180deg, rgba(20, 0, 0, 0.78) 0%, rgba(255, 0, 0, 0.1) 100%);
    border-radius: 20px;
    padding: 35px;
    margin-bottom: 40px;
    border: 1px solid rgba(255, 0, 0, 0.35);
    backdrop-filter: blur(10px);
    box-shadow: 0 10px 30px rgba(0,0,0,0.6), 0 0 20px rgba(255, 0, 0, 0.3);
  }

  .box h3, .box h4 {
    color: #ff4d4d;
    margin-bottom: 28px;
    font-size: 1.5rem;
    text-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
  }

  input, textarea, select {
    width: 100%;
    padding: 16px 18px;
    border-radius: 12px;
    border: 1px solid rgba(255, 0, 0, 0.45);
    background: rgba(40, 0, 0, 0.65);
    color: white;
    margin-bottom: 20px;
    font-size: 1.05rem;
    transition: all 0.3s;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #ff0000;
    box-shadow: 0 0 0 4px rgba(255, 0, 0, 0.4), 0 0 20px rgba(255, 0, 0, 0.6);
  }

  button.action-btn {
    background: linear-gradient(135deg, #ff0000, #cc0000);
    color: white;
    border: none;
    padding: 16px 24px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1.1rem;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 6px 20px rgba(255, 0, 0, 0.6), 0 0 30px rgba(255, 0, 0, 0.4);
    position: relative;
    overflow: hidden;
    text-shadow: 0 0 5px rgba(0,0,0,0.6);
  }

  button.action-btn::before {
    content: '';
    position: absolute;
    top: 50%;
    left: 50%;
    width: 0;
    height: 0;
    background: rgba(255,255,255,0.25);
    border-radius: 50%;
    transform: translate(-50%, -50%);
    transition: width 0.6s ease, height 0.6s ease;
  }

  button.action-btn:hover::before {
    width: 400px;
    height: 400px;
  }

  button.action-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 15px 35px rgba(255, 0, 0, 0.8), 0 0 50px rgba(255, 0, 0, 1);
    background: linear-gradient(135deg, #ff4d4d, #ff0000);
  }

  .delete-btn {
    background: #990000;
    color: white;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(153, 0, 0, 0.5), 0 0 15px rgba(153, 0, 0, 0.3);
    text-shadow: 0 0 5px rgba(0,0,0,0.6);
  }

  .delete-btn:hover { 
    background: #cc0000; 
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(153, 0, 0, 0.7), 0 0 30px rgba(153, 0, 0, 0.6);
  }

  .approve-btn {
    background: #00cc66;
    color: white;
    padding: 10px 18px;
    border-radius: 10px;
    border: none;
    cursor: pointer;
    font-size: 1rem;
    transition: all 0.3s;
    box-shadow: 0 4px 10px rgba(0, 204, 102, 0.5), 0 0 15px rgba(0, 204, 102, 0.3);
    text-shadow: 0 0 5px rgba(0,0,0,0.6);
  }

  .approve-btn:hover { 
    background: #00ff80; 
    transform: scale(1.1);
    box-shadow: 0 8px 20px rgba(0, 204, 102, 0.7), 0 0 30px rgba(0, 204, 102, 0.6);
  }

  .user-list-item, .product-item, .order-item, .discount-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 20px 24px;
    background: rgba(40, 0, 0, 0.55);
    border-radius: 14px;
    margin: 14px 0;
    border: 1px solid rgba(255, 0, 0, 0.3);
    flex-wrap: wrap;
    gap: 20px;
    font-size: 1.1rem;
    transition: all 0.3s;
  }

  .user-list-item:hover, .product-item:hover, .order-item:hover, .discount-item:hover {
    box-shadow: 0 0 20px rgba(255, 0, 0, 0.4);
  }

  .search-input {
    margin-bottom: 28px;
    font-size: 1.1rem;
    padding: 18px 20px;
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.88);
    backdrop-filter: blur(12px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
    transition: opacity 0.3s ease;
  }

  .modal.hidden { display: none; }

  .modal .box {
    width: 95%;
    max-width: 1200px;
    background: rgba(20, 0, 0, 0.96);
    border-radius: 24px;
    padding: 50px 60px;
    border: 1px solid rgba(255, 0, 0, 0.5);
    box-shadow: 0 35px 80px rgba(0,0,0,0.75), 0 0 60px rgba(255, 0, 0, 0.3);
    max-height: 90vh;
    overflow-y: auto;
    animation: fadeIn 0.5s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; transform: scale(0.9); }
    to { opacity: 1; transform: scale(1); }
  }

  .modal h3 {
    color: #ff4d4d;
    text-align: center;
    margin-bottom: 40px;
    font-size: 2.1rem;
    text-shadow: 0 0 12px rgba(255, 77, 77, 0.6);
  }

  .qr-container {
    max-width: 380px;
    margin: 24px auto;
    padding: 12px;
    background: rgba(0,0,0,0.4);
    border-radius: 16px;
    border: 3px solid #ff0000;
    box-shadow: 0 0 25px rgba(255, 0, 0, 0.5);
    text-align: center;
  }

  .qr-preview {
    max-width: 100%;
    height: auto;
    display: block;
    border-radius: 12px;
    object-fit: contain;
    border: 2px solid rgba(255,255,255,0.15);
  }

  @media (max-width: 768px) {
    .wrap { flex-direction: column; }
    .sidebar { width: 100%; }
    .logo { font-size: 1.6rem; }
    .logo span:first-child { font-size: 2rem; }
    .logo span:last-child { font-size: 1.2rem; }
    .modal .box { padding: 30px 20px; }
    .qr-container { max-width: 320px; }
  }

  @import url('https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css');
</style>
</head>
<body>

<div id="loadingOverlay" style="position:fixed;inset:0;background:rgba(10,0,0,0.96);backdrop-filter:blur(12px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;opacity:0;visibility:hidden;transition:all 0.4s;">
  <div class="spinner" style="width:90px;height:90px;border:10px solid rgba(255,0,0,0.3);border-top:10px solid #ff0000;border-radius:50%;animation:spin 1s linear infinite;"></div>
  <div style="margin-top:35px;font-size:1.4rem;font-weight:700;color:#ff0000;">Đang xử lý...</div>
</div>

<div class="top">
  <div class="logo"><span>TUN</span><span>MEDIA</span></div>
  <div class="top-right" id="topRight"></div>
</div>

<div class="wrap">
  <div class="sidebar">
    <h3>MENU</h3>
    <a onclick="view='shop';render()"><i class="fas fa-shopping-cart"></i>Cửa hàng</a>
    <a onclick="view='nap';render()"><i class="fas fa-wallet"></i>Nạp tiền</a>
    <a onclick="view='orders';render()"><i class="fas fa-history"></i>Lịch sử mua</a>
  </div>
  <div class="content" id="content"></div>
</div>

<!-- Modal Đăng nhập -->
<div class="modal hidden" id="loginModal">
  <div class="box" style="max-width:520px">
    <h3>Đăng Nhập</h3>
    <input id="lu" placeholder="Tên đăng nhập">
    <input id="lp" type="password" placeholder="Mật khẩu">
    <button class="action-btn" onclick="login()">Đăng Nhập</button>
  </div>
</div>

<!-- Modal Đăng ký -->
<div class="modal hidden" id="regModal">
  <div class="box" style="max-width:520px">
    <h3>Tạo Tài Khoản Mới</h3>
    <input id="ru" placeholder="Tên đăng nhập">
    <input id="rp" type="password" placeholder="Mật khẩu">
    <button class="action-btn" onclick="register()">Tạo Tài Khoản</button>
  </div>
</div>

<!-- Modal Mua hàng -->
<div class="modal hidden" id="buyModal">
  <div class="box" style="max-width:520px">
    <h3>Xác Nhận Mua</h3>
    <p id="buyProductName"></p>
    <p id="buyProductPrice"></p>
    <input id="discountCode" placeholder="Nhập mã giảm giá (nếu có)">
    <p id="finalPrice"></p>
    <button class="action-btn" onclick="confirmBuy()">Xác Nhận Mua</button>
  </div>
</div>

<!-- Modal Admin -->
<div class="modal hidden" id="adminModal">
  <div class="box">
    <h3>Admin Panel</h3>

    <!-- Quản lý người dùng -->
    <div class="box">
      <h4 style="color:#ff9999;">Quản lý người dùng</h4>
      <input id="userSearch" class="search-input" placeholder="Tìm kiếm tên user..." oninput="renderUserList()">
      <div id="userList"></div>
      
      <h4 style="color:#ff9999;margin-top:40px;">Thêm người dùng mới</h4>
      <input id="newUserName" placeholder="Tên đăng nhập">
      <input id="newUserPass" type="password" placeholder="Mật khẩu">
      <input id="newUserBalance" type="number" placeholder="Số dư ban đầu (đ)">
      <button class="action-btn" onclick="addNewUser()">Thêm User</button>
    </div>

    <!-- Duyệt đơn hàng -->
    <div class="box">
      <h4 style="color:#ff9999;">Duyệt đơn hàng</h4>
      <div id="pendingOrders"></div>
    </div>

    <!-- Quản lý sản phẩm -->
    <div class="box">
      <h4 style="color:#ff9999;">Quản lý sản phẩm</h4>
      <div id="productList"></div>
      
      <h4 style="color:#ff9999;margin-top:40px;">Thêm sản phẩm mới</h4>
      <input id="newProductName" placeholder="Tên sản phẩm">
      <input id="newProductDesc" placeholder="Mô tả ngắn">
      <input id="newProductPrice" type="number" placeholder="Giá (đ)">
      <input id="newProductInventory" type="number" placeholder="Số lượng tồn kho">
      <button class="action-btn" onclick="addNewProduct()">Thêm Sản Phẩm</button>
    </div>

    <!-- Quản lý mã giảm giá -->
    <div class="box">
      <h4 style="color:#ff9999;">Quản lý mã giảm giá</h4>
      <div id="discountList"></div>
      
      <h4 style="color:#ff9999;margin-top:40px;">Thêm mã giảm giá mới</h4>
      <input id="newDiscountCode" placeholder="Mã giảm giá (ví dụ: DISCOUNT10)">
      <input id="newDiscountPercent" type="number" placeholder="Phần trăm giảm (ví dụ: 10)">
      <button class="action-btn" onclick="addNewDiscount()">Thêm Mã</button>
    </div>

    <!-- Thông báo trang chủ -->
    <div class="box">
      <h4 style="color:#ff9999;">Thông báo trang chủ</h4>
      <textarea id="n" rows="4" placeholder="Nhập thông báo..."></textarea>
      <button class="action-btn" onclick="saveNotice()">Lưu</button>
    </div>

    <!-- QR Nạp tiền -->
    <div class="box">
      <h4 style="color:#ff9999;">QR Nạp tiền</h4>
      <input type="file" id="qrFileInput" accept="image/*">
      <p style="font-size:1rem;color:#ff9999;margin:12px 0;">Chọn ảnh QR mới (hoặc giữ nguyên QR cũ)</p>
      
      <div class="qr-container">
        <img id="qrPreview" class="qr-preview" src="https://i.imgur.com/9Z7Y9Kb.png" alt="QR hiện tại">
      </div>
      
      <input id="qn" placeholder="Ghi chú (hiển thị dưới QR)">
      <button class="action-btn" onclick="saveQR()">Lưu QR & Ghi chú</button>
    </div>

    <!-- === PHẦN SAO LƯU / KHÔI PHỤC DỮ LIỆU === -->
    <div class="box" style="margin-top:30px; border-color:#ffcc00;">
      <h4 style="color:#ffcc00;">Sao lưu / Khôi phục toàn bộ dữ liệu</h4>
      <p style="color:#ff9999; font-size:0.95rem; margin-bottom:16px;">
        Dùng để chuyển dữ liệu từ điện thoại sang máy tính hoặc ngược lại
      </p>
      
      <div style="display: flex; gap: 12px; flex-wrap: wrap; margin-bottom: 20px;">
        <button class="action-btn" 
                style="background:linear-gradient(135deg,#ffaa00,#cc8800);"
                onclick="exportAndCopyData()">
          Sao chép dữ liệu (tự động copy)
        </button>
        
        <button class="action-btn" 
                style="background:#555; color:#ccc;"
                onclick="alert('Dán dữ liệu export từ thiết bị khác vào ô bên dưới rồi nhấn Khôi phục')">
          Hướng dẫn khôi phục
        </button>
      </div>

      <textarea id="importDataTextarea" rows="5" placeholder="Dán chuỗi dữ liệu export từ thiết bị khác vào đây..." style="margin:16px 0; font-family:monospace; font-size:0.9rem;"></textarea>
      
      <button class="action-btn" style="background:linear-gradient(135deg,#00cc66,#009955);" onclick="importData()">
        Khôi phục dữ liệu
      </button>
    </div>

    <button class="action-btn" style="background:#4b5563;margin-top:40px;width:100%;font-size:1.3rem;" onclick="closeAdmin()">Đóng</button>
  </div>
</div>

<!-- THÊM FIREBASE SDK (để code chạy được) -->
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

<script>
// ================== KẾT NỐI VỚI FIREBASE ==================
const firebaseConfig = {
  apiKey: "AIzaSyCd7ostkXLtRFixuTCLMTDM1H5UX44xwn0",
  authDomain: "tun-media-shop.firebaseapp.com",
  databaseURL: "https://tun-media-shop-default-rtdb.firebaseio.com",
  projectId: "tun-media-shop",
  storageBucket: "tun-media-shop.firebasestorage.app",
  messagingSenderId: "558685583933",
  appId: "1:558685583933:web:5290bd98958b6804350854",
  measurementId: "G-YLV8WBFNFF"
};

let db;
try {
  firebase.initializeApp(firebaseConfig);
  db = firebase.database();
} catch (e) {
  console.error("Lỗi khởi tạo Firebase:", e);
}

// ================== BIẾN TOÀN CỤC ==================
const loadingOverlay = document.getElementById("loadingOverlay");
function showLoading() { 
  if (loadingOverlay) {
    loadingOverlay.style.opacity = "1"; 
    loadingOverlay.style.visibility = "visible"; 
  }
}
function hideLoading() { 
  setTimeout(() => { 
    if (loadingOverlay) {
      loadingOverlay.style.opacity = "0"; 
      loadingOverlay.style.visibility = "hidden"; 
    }
  }, 600); 
}

let users = [];
let products = [];
let discounts = [];
let notice = "⚡ Shop uy tín - Giao dịch an toàn 100%";
let qr = "https://i.imgur.com/9Z7Y9Kb.png";
let qrNote = "Chuyển khoản đúng nội dung → tiền tự động cộng trong 1-5 phút";
let currentUser = JSON.parse(localStorage.getItem("currentUser") || "null");  // Giữ local cho currentUser để nhớ đăng nhập
let view = "shop";
const ADMIN_PASSWORD = "admin123";
let currentBuyIndex = -1;

// Hàm hash (bạn dùng hash() nhiều nơi nhưng không định nghĩa → gây lỗi dừng script)
function hash(str) {
  let h = 0;
  for (let i = 0; i < str.length; i++) {
    const char = str.charCodeAt(i);
    h = ((h << 5) - h) + char;
    h = h & h; // Convert to 32bit integer
  }
  return h.toString(36);
}

// Hàm isAdmin (bạn dùng trong render nhưng chưa định nghĩa)
function isAdmin() {
  return currentUser && currentUser.u === "admin";
}

// Khởi tạo admin nếu chưa có
if (db) {
  db.ref('users').once('value').then((snapshot) => {
    const allUsers = snapshot.val() || [];
    if (!allUsers.some(u => u.u === "admin")) {
      allUsers.push({ u: "admin", p: hash("admin123"), balance: 0, orders: [] });
      db.ref('users').set(allUsers);
    }
  }).catch(err => console.error("Lỗi init admin:", err));
}

// Load dữ liệu từ Firebase khi trang khởi động
function loadDataFromFirebase() {
  if (!db) {
    render();
    return;
  }
  db.ref('/').once('value').then((snapshot) => {
    const data = snapshot.val() || {};
    users = data.users || [];
    products = data.products || [];
    discounts = data.discounts || [];
    notice = data.notice || notice;
    qr = data.qr || qr;
    qrNote = data.qrNote || qrNote;
    render();
  }).catch((error) => {
    console.error("Lỗi load Firebase:", error);
    render();
  });
}

// Lưu dữ liệu lên Firebase
function saveAll() {
  if (!db) return;
  const data = {
    users,
    products,
    discounts,
    notice,
    qr,
    qrNote
  };
  db.ref('/').set(data).then(() => {
    console.log("Đã lưu lên Firebase");
  }).catch((error) => {
    console.error("Lỗi lưu Firebase:", error);
  });
}

// ================== RENDER CHÍNH ==================
function render() {
  const topRight = document.getElementById("topRight");
  let html = currentUser 
    ? `<span style="color:#ff9999; font-weight:600;">${currentUser.u} • <span style="color:#ffcc00;">${Number(currentUser.balance || 0).toLocaleString('vi-VN')}đ</span></span>`
    : `<button onclick="openLogin()">Đăng nhập</button><button onclick="openRegister()">Đăng ký</button>`;

  if (isAdmin()) {
    html += `<button class="admin-btn" onclick="openAdminPanel()">Admin Panel</button>`;
  }

  if (currentUser) html += `<button onclick="logout()">Thoát</button>`;
  topRight.innerHTML = html;

  const content = document.getElementById("content");

  if(view === "shop") {
    if (currentUser) {
      products.forEach(p => {
        if (Math.random() < 0.1) p.sold = (p.sold || 0) + Math.floor(Math.random() * 2 + 1);
      });
      saveAll();
    }

    content.innerHTML = `
      <div class="notice">${notice}</div>
      <div class="products">
        ${products.length ? products.map((p,i)=>`
          <div class="card">
            <h4>${p.name}</h4>
            <div style="color:#ff9999;margin:10px 0;">${p.desc || ''}</div>
            <div class="price">${Number(p.price || 0).toLocaleString('vi-VN')}đ</div>
            <div class="sold">Đã bán: <strong>${Number(p.sold || 0).toLocaleString('vi-VN')}</strong></div>
            <div class="inventory">Còn lại: <strong>${Number(p.inventory || 0).toLocaleString('vi-VN')} cái</strong></div>
            <div class="buy" onclick="${p.inventory > 0 ? `openBuyModal(${i})` : `alert('Sản phẩm tạm hết hàng!')`}">${p.inventory > 0 ? 'MUA NGAY' : 'HẾT HÀNG'}</div>
          </div>
        `).join("") : "<div style='text-align:center;padding:100px 0;color:#ff9999;font-size:1.3rem;'>Chưa có sản phẩm</div>"}
      </div>`;
  }

  if(view === "nap") {
    content.innerHTML = `
      <div class="box" style="text-align:center">
        <h3>Nạp Tiền</h3>
        ${qr ? `
          <div class="qr-container">
            <img src="${qr}" alt="QR" class="qr-preview">
          </div>
        ` : "<p style='color:#ff9999'>Chưa có QR</p>"}
        <p style="margin:30px 0;color:#ff9999;font-size:1.1rem;">${qrNote}</p>
        <p style="color:#ff9999;font-size:1.05rem;">Nội dung chuyển khoản: <strong style="color:#ffcc00;">${currentUser ? currentUser.u + ' nap tien' : 'ten_tai_khoan nap tien'}</strong></p>
      </div>`;
  }

  if(view === "orders") {
    if (!currentUser) {
      content.innerHTML = "<div style='text-align:center;padding:100px 0;color:#ff9999;font-size:1.3rem;'>Vui lòng đăng nhập để xem lịch sử mua.</div>";
      return;
    }
    let ordersHtml = "";
    (currentUser.orders || []).forEach(order => {
      ordersHtml += `
        <div class="order-item">
          <div>
            <strong style="color:#ff9999;font-size:1.2rem;">${order.productName}</strong><br>
            <span style="color:#ff9999;">Ngày: ${order.date}</span><br>
            <span style="color:${order.status === 'pending' ? '#ffcc00' : '#00ff99'};font-weight:600;">Trạng thái: ${order.status === 'pending' ? 'Đợi duyệt' : 'Đã duyệt'}</span>
          </div>
          ${order.status === 'approved' && order.details ? `<button class="approve-btn" onclick="showDetails('${order.details.replace(/'/g, "\\'")}')">Xem TK/MK</button>` : ''}
        </div>
      `;
    });
    content.innerHTML = `
      <div class="box">
        <h3>Lịch sử mua của bạn</h3>
        ${ordersHtml || "<p style='text-align:center;color:#ff9999;font-size:1.2rem;'>Chưa có đơn hàng nào.</p>"}
      </div>
    `;
  }
}

function showDetails(details) {
  alert(`Chi tiết tài khoản / mật khẩu:\n\n${details}`);
}

// ================== AUTH ==================
function openLogin() { document.getElementById("loginModal").classList.remove("hidden"); }
function openRegister() { document.getElementById("regModal").classList.remove("hidden"); }

function login() {
  const u = document.getElementById("lu").value.trim();
  const p = document.getElementById("lp").value;
  if (!u || !p) return alert("Vui lòng nhập đầy đủ thông tin!");
  if (u.length < 4 || p.length < 6) return alert("Tên đăng nhập ≥4 ký tự, mật khẩu ≥6 ký tự!");

  const user = users.find(x => x.u === u && x.p === hash(p));
  if (!user) return alert("Sai tên đăng nhập hoặc mật khẩu!");

  currentUser = {...user};
  localStorage.setItem("currentUser", JSON.stringify(currentUser));
  document.getElementById("loginModal").classList.add("hidden");
  render();
  alert("Đăng nhập thành công!");
}

function register() {
  const u = document.getElementById("ru").value.trim();
  const p = document.getElementById("rp").value;

  if (u.length < 4) return alert("Tên đăng nhập phải ≥ 4 ký tự");
  if (p.length < 6) return alert("Mật khẩu phải ≥ 6 ký tự");
  if (users.some(x => x.u === u)) return alert("Tên đăng nhập đã tồn tại!");

  const newUser = { u, p: hash(p), balance: 0, orders: [] };
  users.push(newUser);
  currentUser = {...newUser};
  saveAll();

  document.getElementById("regModal").classList.add("hidden");
  render();
  alert("Đăng ký thành công! Bạn đã được đăng nhập tự động.");
}

function logout() {
  if (!confirm("Bạn có chắc muốn đăng xuất?")) return;
  currentUser = null;
  localStorage.removeItem("currentUser");
  render();
  alert("Đã đăng xuất!");
}

// ================== MUA HÀNG ==================
function openBuyModal(index) {
  if (!currentUser) return alert("Vui lòng đăng nhập để mua!");

  const product = products[index];
  if (!product || product.inventory <= 0) return alert("Sản phẩm không tồn tại hoặc hết hàng!");

  currentBuyIndex = index;
  document.getElementById("buyProductName").innerText = `Sản phẩm: ${product.name}`;
  document.getElementById("buyProductPrice").innerText = `Giá gốc: ${Number(product.price).toLocaleString('vi-VN')}đ`;
  document.getElementById("finalPrice").innerText = `Giá cuối: ${Number(product.price).toLocaleString('vi-VN')}đ`;
  document.getElementById("discountCode").value = "";
  document.getElementById("buyModal").classList.remove("hidden");

  document.getElementById("discountCode").oninput = function() {
    const code = this.value.trim().toUpperCase();
    const discount = discounts.find(d => d.code === code);
    let finalPrice = product.price;
    if (discount) {
      finalPrice = Math.round(product.price * (1 - discount.percent / 100));
      alert(`Áp dụng thành công! Giảm ${discount.percent}%`);
    } else if (code) {
      alert("Mã giảm giá không hợp lệ!");
    }
    document.getElementById("finalPrice").innerText = `Giá cuối: ${Number(finalPrice).toLocaleString('vi-VN')}đ`;
  };
}

function confirmBuy() {
  const product = products[currentBuyIndex];
  const code = document.getElementById("discountCode").value.trim().toUpperCase();
  const discount = discounts.find(d => d.code === code);
  let finalPrice = product.price;
  if (discount) {
    finalPrice = Math.round(product.price * (1 - discount.percent / 100));
  }

  if (currentUser.balance < finalPrice) return alert("Không đủ tiền! Vui lòng nạp thêm.");

  if (confirm(`Mua "${product.name}" với giá ${Number(finalPrice).toLocaleString('vi-VN')}đ ?`)) {
    showLoading();
    setTimeout(() => {
      currentUser.balance -= finalPrice;
      product.sold = (product.sold || 0) + 1;
      product.inventory = (product.inventory || 0) - 1;

      currentUser.orders = currentUser.orders || [];
      currentUser.orders.push({
        productName: product.name,
        date: new Date().toLocaleString('vi-VN'),
        status: 'pending'
      });

      const userIndex = users.findIndex(u => u.u === currentUser.u);
      if (userIndex !== -1) users[userIndex] = {...currentUser};

      saveAll();
      localStorage.setItem("currentUser", JSON.stringify(currentUser)); // Lưu local cho user hiện tại
      document.getElementById("buyModal").classList.add("hidden");
      render();
      hideLoading();
      alert("Đơn hàng đã được tạo! Chờ admin duyệt.");
    }, 700);
  }
}

// ================== ADMIN ==================
function openAdminPanel() {
  const pass = prompt("Nhập mật khẩu Admin:");
  if (pass !== ADMIN_PASSWORD) {
    if (pass !== null) alert("Mật khẩu sai!");
    return;
  }

  document.getElementById("adminModal").classList.remove("hidden");
  document.getElementById("n").value = notice;
  document.getElementById("qn").value = qrNote;
  document.getElementById("qrPreview").src = qr;
  renderUserList();
  renderPendingOrders();
  renderProductList();
  renderDiscountList();
}

function closeAdmin() {
  document.getElementById("adminModal").classList.add("hidden");
}

// ================== SAO LƯU / KHÔI PHỤC DỮ LIỆU ==================
function exportAndCopyData() {
  const data = {
    users,
    products,
    discounts,
    notice,
    qr,
    qrNote
  };
  
  const jsonStr = JSON.stringify(data, null, 2);
  
  navigator.clipboard.writeText(jsonStr).then(() => {
    alert("Đã sao chép toàn bộ dữ liệu vào bộ nhớ tạm!\n\nBạn chỉ cần dán (Ctrl+V) vào ô khôi phục trên thiết bị khác là được.");
  }).catch(err => {
    prompt("Copy thủ công (Ctrl+C):\n\n", jsonStr);
    alert("Trình duyệt không cho phép tự động copy. Vui lòng copy thủ công từ hộp thoại.");
  });
}

function importData() {
  const textarea = document.getElementById("importDataTextarea");
  const text = textarea.value.trim();
  
  if (!text) {
    alert("Vui lòng dán dữ liệu vào ô trước!");
    return;
  }

  try {
    const imported = JSON.parse(text);
    
    users = imported.users || [];
    products = imported.products || [];
    discounts = imported.discounts || [];
    notice = imported.notice || notice;
    qr = imported.qr || qr;
    qrNote = imported.qrNote || qrNote;

    saveAll();
    render();
    alert("Khôi phục dữ liệu thành công!\n\n Trang sẽ tự động cập nhật giống dữ liệu bạn đã sao lưu.");
    
    document.getElementById("n").value = notice;
    document.getElementById("qn").value = qrNote;
    document.getElementById("qrPreview").src = qr;
    renderUserList();
    renderPendingOrders();
    renderProductList();
    renderDiscountList();
  } catch (err) {
    alert("Dữ liệu không đúng định dạng JSON!\nVui lòng kiểm tra lại chuỗi bạn dán.");
    console.error(err);
  }
}

// ================== CÁC HÀM ADMIN KHÁC ==================
function renderUserList() {
  const search = document.getElementById("userSearch").value.toLowerCase().trim();
  const container = document.getElementById("userList");
  let html = "";

  const filtered = users.filter(u => u.u !== "admin" && (!search || u.u.toLowerCase().includes(search)));

  filtered.forEach((user, i) => {
    html += `
      <div class="user-list-item">
        <div>
          <strong style="color:#ff9999;font-size:1.25rem;">${user.u}</strong><br>
          <span style="color:#ff9999;">Số dư: ${Number(user.balance || 0).toLocaleString('vi-VN')}đ</span>
        </div>
        <div style="display:flex;gap:12px;flex-wrap:wrap;">
          <input type="number" id="amt_${i}" placeholder="Số tiền" style="width:140px;">
          <button class="action-btn" onclick="changeBalance(${i}, true)">+ Tiền</button>
          <button class="action-btn" style="background:#990000;" onclick="changeBalance(${i}, false)">- Tiền</button>
          <button class="delete-btn" onclick="deleteUser(${i})">Xóa</button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html || "<p style='text-align:center;color:#ff9999;padding:20px;'>Không tìm thấy user</p>";
}

function changeBalance(index, isAdd) {
  const input = document.getElementById(`amt_${index}`);
  const amount = Number(input.value);
  if (isNaN(amount) || amount <= 0) return alert("Nhập số tiền hợp lệ >0!");

  if (!confirm(`Xác nhận ${isAdd ? 'cộng' : 'trừ'} ${amount.toLocaleString('vi-VN')}đ ?`)) return;

  showLoading();
  setTimeout(() => {
    if (isAdd) users[index].balance = (users[index].balance || 0) + amount;
    else users[index].balance = Math.max(0, (users[index].balance || 0) - amount);

    if (currentUser && currentUser.u === users[index].u) {
      currentUser.balance = users[index].balance;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
    }

    saveAll();
    renderUserList();
    render();
    hideLoading();
    alert(`Đã ${isAdd ? 'cộng' : 'trừ'} tiền thành công!`);
  }, 600);
}

function deleteUser(index) {
  if (users[index].u === "admin") return alert("Không thể xóa tài khoản admin!");
  if (!confirm("Xóa người dùng này vĩnh viễn? Tất cả dữ liệu sẽ mất!")) return;

  showLoading();
  setTimeout(() => {
    if (currentUser && currentUser.u === users[index].u) {
      logout();
    }
    users.splice(index, 1);
    saveAll();
    renderUserList();
    render();
    hideLoading();
    alert("Đã xóa user!");
  }, 600);
}

function addNewUser() {
  const name = document.getElementById("newUserName").value.trim();
  const pass = document.getElementById("newUserPass").value;
  const bal = Number(document.getElementById("newUserBalance").value) || 0;

  if (name.length < 4) return alert("Tên đăng nhập phải ≥4 ký tự!");
  if (pass.length < 6) return alert("Mật khẩu phải ≥6 ký tự!");
  if (users.some(u => u.u === name)) return alert("Tên đăng nhập đã tồn tại!");
  if (isNaN(bal) || bal < 0) return alert("Số dư phải là số ≥0!");

  showLoading();
  setTimeout(() => {
    users.push({ u: name, p: hash(pass), balance: bal, orders: [] });
    saveAll();
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserBalance").value = "";
    renderUserList();
    hideLoading();
    alert("Đã thêm user mới!");
  }, 700);
}

function renderPendingOrders() {
  const container = document.getElementById("pendingOrders");
  let html = "";

  users.forEach((user, userIdx) => {
    (user.orders || []).forEach((order, ordIdx) => {
      if (order.status === 'pending') {
        html += `
          <div class="order-item">
            <div>
              <strong style="color:#ff9999;font-size:1.25rem;">${user.u}</strong><br>
              <span style="color:#ff9999;">Sản phẩm: ${order.productName}</span><br>
              <span style="color:#ffcc00;">${order.date}</span>
            </div>
            <button class="approve-btn" onclick="approveOrder(${userIdx}, ${ordIdx})">Duyệt & Gửi TK/MK</button>
          </div>
        `;
      }
    });
  });

  container.innerHTML = html || "<p style='text-align:center;color:#ff9999;padding:20px;'>Không có đơn chờ duyệt</p>";
}

function approveOrder(userIdx, orderIndex) {
  const details = prompt("Nhập tài khoản / mật khẩu cho đơn này (bắt buộc):");
  if (!details.trim()) return alert("Bạn phải nhập thông tin tài khoản!");

  showLoading();
  setTimeout(() => {
    users[userIdx].orders[orderIndex].status = 'approved';
    users[userIdx].orders[orderIndex].details = details;

    if (currentUser && currentUser.u === users[userIdx].u) {
      currentUser.orders = users[userIdx].orders;
      localStorage.setItem("currentUser", JSON.stringify(currentUser));
    }

    saveAll();
    renderPendingOrders();
    render();
    hideLoading();
    alert("Đã duyệt đơn và gửi chi tiết!");
  }, 700);
}

function renderProductList() {
  const container = document.getElementById("productList");
  let html = "";

  products.forEach((p, i) => {
    html += `
      <div class="product-item">
        <div>
          <strong style="color:#ff9999;">${p.name}</strong><br>
          <span style="color:#ff9999;">${p.desc || ''} - ${Number(p.price).toLocaleString('vi-VN')}đ - Tồn kho: ${p.inventory || 0}</span>
        </div>
        <div style="display:flex;gap:12px;">
          <input type="number" id="inv_${i}" placeholder="Tồn kho mới" style="width:140px;">
          <button class="action-btn" style="background:#00cc66;" onclick="updateInventory(${i})">Cập nhật Tồn kho</button>
          <button class="delete-btn" onclick="deleteProduct(${i})">Xóa</button>
        </div>
      </div>
    `;
  });

  container.innerHTML = html || "<p style='text-align:center;color:#ff9999;padding:20px;'>Chưa có sản phẩm</p>";
}

function updateInventory(index) {
  const input = document.getElementById(`inv_${index}`);
  const newInv = Number(input.value);
  if (isNaN(newInv) || newInv < 0) return alert("Số lượng tồn kho phải ≥0!");

  if (!confirm(`Cập nhật tồn kho thành ${newInv}?`)) return;

  showLoading();
  setTimeout(() => {
    products[index].inventory = newInv;
    saveAll();
    renderProductList();
    hideLoading();
    alert("Đã cập nhật tồn kho!");
  }, 600);
}

function addNewProduct() {
  const name = document.getElementById("newProductName").value.trim();
  const desc = document.getElementById("newProductDesc").value.trim();
  const price = Number(document.getElementById("newProductPrice").value);
  const inventory = Number(document.getElementById("newProductInventory").value) || 0;

  if (!name) return alert("Nhập tên sản phẩm!");
  if (isNaN(price) || price <= 0) return alert("Giá phải là số dương!");
  if (isNaN(inventory) || inventory < 0) return alert("Tồn kho phải ≥0!");

  showLoading();
  setTimeout(() => {
    products.push({ name, desc, price, sold: 0, inventory });
    saveAll();
    document.getElementById("newProductName").value = "";
    document.getElementById("newProductDesc").value = "";
    document.getElementById("newProductPrice").value = "";
    document.getElementById("newProductInventory").value = "";
    renderProductList();
    hideLoading();
    alert("Đã thêm sản phẩm!");
  }, 700);
}

function deleteProduct(index) {
  if (!confirm("Xóa sản phẩm này? Tất cả dữ liệu liên quan sẽ mất!")) return;
  showLoading();
  setTimeout(() => {
    products.splice(index, 1);
    saveAll();
    renderProductList();
    hideLoading();
    alert("Đã xóa sản phẩm!");
  }, 600);
}

function renderDiscountList() {
  const container = document.getElementById("discountList");
  let html = "";

  discounts.forEach((d, i) => {
    html += `
      <div class="discount-item">
        <div>
          <strong style="color:#ff9999;">${d.code}</strong><br>
          <span style="color:#ff9999;">Giảm ${d.percent}%</span>
        </div>
        <button class="delete-btn" onclick="deleteDiscount(${i})">Xóa</button>
      </div>
    `;
  });

  container.innerHTML = html || "<p style='text-align:center;color:#ff9999;padding:20px;'>Chưa có mã giảm giá</p>";
}

function addNewDiscount() {
  const code = document.getElementById("newDiscountCode").value.trim().toUpperCase();
  const percent = Number(document.getElementById("newDiscountPercent").value);

  if (!code) return alert("Nhập mã giảm giá!");
  if (isNaN(percent) || percent <= 0 || percent > 100) return alert("Phần trăm giảm phải từ 1-100!");
  if (discounts.some(d => d.code === code)) return alert("Mã đã tồn tại!");

  showLoading();
  setTimeout(() => {
    discounts.push({ code, percent });
    saveAll();
    document.getElementById("newDiscountCode").value = "";
    document.getElementById("newDiscountPercent").value = "";
    renderDiscountList();
    hideLoading();
    alert("Đã thêm mã giảm giá!");
  }, 700);
}

function deleteDiscount(index) {
  if (!confirm("Xóa mã giảm giá này?")) return;
  showLoading();
  setTimeout(() => {
    discounts.splice(index, 1);
    saveAll();
    renderDiscountList();
    hideLoading();
    alert("Đã xóa mã giảm giá!");
  }, 600);
}

function saveNotice() {
  const newNotice = document.getElementById("n").value.trim();
  if (!newNotice) return alert("Thông báo không được để trống!");
  notice = newNotice;
  saveAll();
  alert("Đã lưu thông báo!");
  render();
}

function saveQR() {
  const note = document.getElementById("qn").value.trim();
  if (!note) return alert("Ghi chú không được để trống!");
  qrNote = note;

  const fileInput = document.getElementById("qrFileInput");
  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      qr = e.target.result;
      document.getElementById("qrPreview").src = qr;
      saveAll();
      alert("Đã cập nhật QR và ghi chú!");
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    saveAll();
    alert("Đã cập nhật ghi chú QR!");
  }
}

// Khởi chạy
loadDataFromFirebase();
render();  // Render ngay lần đầu để tránh trang trắng
</script>
</body>
</html>