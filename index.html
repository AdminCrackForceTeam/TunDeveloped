<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>DIGITAL STORE - Shop Uy Tín</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0f0f0f;
    color: #e2e8f0;
    min-height: 100vh;
    background: linear-gradient(135deg, #1a0000 0%, #300000 100%);
  }

  .top {
    height: 70px;
    background: rgba(30, 0, 0, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    border-bottom: 1px solid rgba(239, 68, 68, 0.3);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    font-size: 1.8rem;
    font-weight: 800;
    background: linear-gradient(90deg, #ef4444, #f87171);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .top-right {
    display: flex;
    align-items: center;
    gap: 16px;
  }
  .top-right button, .top-right .admin-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  }

  .top-right button:hover, .top-right .admin-btn:hover {
    transform: translateY(-3px) scale(1.05);
    box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
    background: linear-gradient(135deg, #f87171, #ef4444);
  }

  .wrap {
    max-width: 1400px;
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    gap: 30px;
  }

  .sidebar {
    width: 260px;
    background: rgba(20, 0, 0, 0.7);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 25px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    height: fit-content;
  }

  .sidebar h3 {
    color: #f87171;
    font-size: 0.95rem;
    font-weight: 700;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 1.5px;
  }

  .sidebar a {
    display: block;
    padding: 14px 18px;
    border-radius: 10px;
    margin-bottom: 8px;
    color: #fda4af;
    font-weight: 500;
    transition: all 0.3s;
    cursor: pointer;
  }

  .sidebar a:hover {
    background: rgba(239, 68, 68, 0.15);
    color: #fef2f2;
    transform: translateX(6px);
  }

  .content { flex: 1; min-width: 320px; }

  .notice {
    background: rgba(30, 0, 0, 0.6);
    border-left: 5px solid #ef4444;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    font-size: 0.98rem;
    backdrop-filter: blur(6px);
  }

  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
  }

  .card {
    background: rgba(20, 0, 0, 0.75);
    border-radius: 16px;
    padding: 24px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    transition: all 0.35s ease;
    backdrop-filter: blur(8px);
  }

  .card:hover {
    transform: translateY(-14px);
    box-shadow: 0 25px 50px -12px rgba(239, 68, 68, 0.35);
    border-color: #ef4444;
  }

  .card h4 {
    color: #fecaca;
    font-size: 1.3rem;
    margin-bottom: 10px;
  }

  .price {
    color: #fbbf24;
    font-size: 1.6rem;
    font-weight: 800;
    margin: 12px 0 8px;
  }

  .sold {
    color: #34d399;
    font-size: 0.95rem;
    font-weight: 600;
    margin-bottom: 16px;
  }

  .buy {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    font-weight: 700;
    text-align: center;
    padding: 14px;
    border-radius: 10px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(239, 68, 68, 0.5);
  }

  .buy:hover {
    transform: scale(1.08);
    box-shadow: 0 15px 35px rgba(239, 68, 68, 0.7);
  }

  .box {
    background: rgba(20, 0, 0, 0.75);
    border-radius: 16px;
    padding: 28px;
    margin-bottom: 30px;
    border: 1px solid rgba(239, 68, 68, 0.2);
    backdrop-filter: blur(8px);
  }

  .box h3, .box h4 {
    color: #f87171;
    margin-bottom: 20px;
  }

  input, textarea, select {
    width: 100%;
    padding: 14px 16px;
    border-radius: 10px;
    border: 1px solid rgba(239, 68, 68, 0.3);
    background: rgba(40, 0, 0, 0.6);
    color: white;
    margin-bottom: 16px;
    font-size: 1rem;
  }

  input:focus, textarea:focus, select:focus {
    outline: none;
    border-color: #ef4444;
    box-shadow: 0 0 0 3px rgba(239, 68, 68, 0.25);
  }

  button.action-btn {
    background: linear-gradient(135deg, #ef4444, #dc2626);
    color: white;
    border: none;
    padding: 14px;
    border-radius: 10px;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s;
    box-shadow: 0 4px 15px rgba(239, 68, 68, 0.4);
  }

  button.action-btn:hover {
    transform: translateY(-2px);
    box-shadow: 0 12px 30px rgba(239, 68, 68, 0.6);
  }

  .delete-btn {
    background: #991b1b;
    color: white;
    padding: 8px 14px;
    border-radius: 8px;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
  }

  .delete-btn:hover {
    background: #b91c1c;
  }

  .product-item, .user-list-item {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 14px;
    background: rgba(40, 0, 0, 0.5);
    border-radius: 10px;
    margin: 10px 0;
    border: 1px solid rgba(239, 68, 68, 0.15);
    flex-wrap: wrap;
    gap: 10px;
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal.hidden {
    display: none;
  }

  .modal .box {
    width: 90%;
    max-width: 900px;
    background: rgba(20, 0, 0, 0.95);
    border-radius: 20px;
    padding: 40px 32px;
    border: 1px solid rgba(239, 68, 68, 0.35);
    box-shadow: 0 30px 70px rgba(0,0,0,0.7);
    position: relative;
    overflow-y: auto;
    max-height: 90vh;
  }

  .modal h3 {
    color: #f87171;
    text-align: center;
    margin-bottom: 28px;
    font-size: 1.6rem;
  }

  .qr-preview {
    max-width: 280px;
    border-radius: 12px;
    border: 2px solid #ef4444;
    margin: 16px auto;
    display: block;
  }

  @media (max-width: 768px) {
    .wrap { flex-direction: column; }
    .sidebar { width: 100%; }
  }
</style>
</head>
<body>

<div id="loadingOverlay" style="position:fixed;inset:0;background:rgba(10,0,0,0.95);backdrop-filter:blur(10px);display:flex;flex-direction:column;align-items:center;justify-content:center;z-index:99999;opacity:0;visibility:hidden;transition:all 0.4s;">
  <div class="spinner" style="width:80px;height:80px;border:8px solid rgba(239,68,68,0.2);border-top:8px solid #ef4444;border-radius:50%;animation:spin 1s linear infinite;"></div>
  <div style="margin-top:30px;font-size:1.2rem;font-weight:600;color:#ef4444;">Đang xử lý...</div>
</div>

<div class="top">
  <div class="logo">DIGITAL STORE</div>
  <div class="top-right" id="topRight"></div>
</div>

<div class="wrap">
  <div class="sidebar">
    <h3>MENU</h3>
    <a onclick="view='shop';render()">Cửa hàng</a>
    <a onclick="view='nap';render()">Nạp tiền</a>
  </div>
  <div class="content" id="content"></div>
</div>

<!-- Modal Đăng nhập -->
<div class="modal hidden" id="loginModal">
  <div class="box" style="max-width:480px">
    <h3>Đăng Nhập</h3>
    <input id="lu" placeholder="Tên đăng nhập">
    <input id="lp" type="password" placeholder="Mật khẩu">
    <button class="action-btn" onclick="login()">Đăng Nhập</button>
  </div>
</div>

<!-- Modal Đăng ký -->
<div class="modal hidden" id="regModal">
  <div class="box" style="max-width:480px">
    <h3>Tạo Tài Khoản Mới</h3>
    <input id="ru" placeholder="Tên đăng nhập (≥4 ký tự)">
    <input id="rp" type="password" placeholder="Mật khẩu (≥6 ký tự)">
    <button class="action-btn" onclick="register()">Tạo Tài Khoản</button>
  </div>
</div>

<!-- Modal Admin -->
<div class="modal hidden" id="adminModal">
  <div class="box">
    <h3>Admin Panel</h3>

    <!-- Quản lý người dùng -->
    <div class="box">
      <h4 style="color:#fecaca;">Quản lý người dùng</h4>
      <div id="userList"></div>
      
      <h4 style="color:#fecaca;margin-top:30px;">Thêm người dùng mới</h4>
      <input id="newUserName" placeholder="Tên đăng nhập">
      <input id="newUserPass" type="password" placeholder="Mật khẩu">
      <input id="newUserBalance" type="number" placeholder="Số dư ban đầu (đ)">
      <button class="action-btn" onclick="addNewUser()">Thêm User</button>
    </div>

    <!-- Quản lý sản phẩm -->
    <div class="box">
      <h4 style="color:#fecaca;">Quản lý sản phẩm</h4>
      <div id="productList"></div>
      
      <h4 style="color:#fecaca;margin-top:30px;">Thêm sản phẩm mới</h4>
      <input id="newProductName" placeholder="Tên sản phẩm">
      <input id="newProductDesc" placeholder="Mô tả ngắn">
      <input id="newProductPrice" type="number" placeholder="Giá (đ)">
      <button class="action-btn" onclick="addNewProduct()">Thêm Sản Phẩm</button>
    </div>

    <!-- Thông báo trang chủ -->
    <div class="box">
      <h4 style="color:#fecaca;">Thông báo trang chủ</h4>
      <textarea id="n" rows="3">${notice}</textarea>
      <button class="action-btn" onclick="saveNotice()">Lưu</button>
    </div>

    <!-- QR Nạp tiền -->
    <div class="box">
      <h4 style="color:#fecaca;">QR Nạp tiền</h4>
      <input type="file" id="qrFileInput" accept="image/*">
      <p style="font-size:0.9rem;color:#fda4af;margin:8px 0;">Chọn ảnh QR mới (hoặc giữ nguyên QR cũ)</p>
      <img id="qrPreview" class="qr-preview" src="${qr}" alt="QR hiện tại">
      <input id="qn" value="${qrNote}" placeholder="Ghi chú (hiển thị dưới QR)">
      <button class="action-btn" onclick="saveQR()">Lưu QR & Ghi chú</button>
    </div>

    <button class="action-btn" style="background:#4b5563;margin-top:20px;" onclick="closeAdmin()">Đóng</button>
  </div>
</div>

<script>
// ================== CÁC BIẾN VÀ HÀM CƠ BẢN ==================
const loadingOverlay = document.getElementById("loadingOverlay");
function showLoading() { loadingOverlay.style.opacity = "1"; loadingOverlay.style.visibility = "visible"; }
function hideLoading() { setTimeout(() => { loadingOverlay.style.opacity = "0"; loadingOverlay.style.visibility = "hidden"; }, 400); }

function getStorage() {
  try { return localStorage; } catch(e) {
    return { data:{}, getItem(k){return this.data[k]||null;}, setItem(k,v){this.data[k]=v+'';}, removeItem(k){delete this.data[k];} };
  }
}
const storage = getStorage();

let users = JSON.parse(storage.getItem("users") || "[]");
let products = JSON.parse(storage.getItem("products") || "[]");
let notice = storage.getItem("notice") || "⚡ Shop uy tín - Giao dịch an toàn 100%";
let qr = storage.getItem("qr") || "https://i.imgur.com/9Z7Y9Kb.png";
let qrNote = storage.getItem("qrNote") || "Chuyển khoản đúng nội dung → tiền tự động cộng trong 1-5 phút";
let currentUser = JSON.parse(storage.getItem("currentUser") || "null");
let view = "shop";
const ADMIN_PASSWORD = "admin123";

function hash(str) {
  let h = 0;
  for(let i = 0; i < str.length; i++) h = (h << 5) - h + str.charCodeAt(i);
  return h.toString(36);
}

function isAdmin() {
  return currentUser && currentUser.u === "admin";
}

// ================== RENDER CHÍNH ==================
function render() {
  const topRight = document.getElementById("topRight");
  let html = currentUser 
    ? `<span>${currentUser.u} • ${Number(currentUser.balance).toLocaleString('vi-VN')}đ</span>`
    : `<button onclick="openLogin()">Đăng nhập</button><button onclick="openRegister()">Đăng ký</button>`;

  if (isAdmin()) {
    html += `<button class="admin-btn" onclick="openAdminPanel()">Admin Panel</button>`;
  }

  if (currentUser) {
    html += `<button onclick="logout()">Thoát</button>`;
  }
  topRight.innerHTML = html;

  const content = document.getElementById("content");

  if(view === "shop") {
    // Tăng nhẹ số lượng đã bán ngẫu nhiên để trông tự nhiên (chỉ khi có user đăng nhập)
    if (currentUser) {
      products.forEach(p => {
        if (Math.random() < 0.08) p.sold += Math.floor(Math.random() * 3) + 1; // tăng 1-3 ngẫu nhiên
      });
      storage.setItem("products", JSON.stringify(products));
    }

    content.innerHTML = `
      <div class="notice">${notice}</div>
      <div class="products">
        ${products.length ? products.map((p,i)=>`
          <div class="card">
            <h4>${p.name}</h4>
            <div style="color:#fda4af;margin:8px 0;">${p.desc}</div>
            <div class="price">${Number(p.price).toLocaleString('vi-VN')}đ</div>
            <div class="sold">Đã có <strong>${Number(p.sold || 0).toLocaleString('vi-VN')}</strong> người mua</div>
            <div class="buy" onclick="buy(${i})">MUA NGAY</div>
          </div>
        `).join("") : "<div style='text-align:center;padding:80px 0;color:#fda4af;'>Chưa có sản phẩm</div>"}
      </div>`;
  }

  if(view === "nap") {
    content.innerHTML = `
      <div class="box" style="text-align:center">
        <h3>Nạp Tiền</h3>
        ${qr ? `<img src="${qr}" alt="QR" style="max-width:300px;border-radius:16px;border:2px solid #ef4444;">` : "<p style='color:#fda4af'>Chưa có QR</p>"}
        <p style="margin:25px 0;color:#fecaca;">${qrNote}</p>
        <p style="color:#fda4af;font-size:0.95rem;">Nội dung chuyển khoản: <strong style="color:#fbbf24;">${currentUser ? currentUser.u + ' nap tien' : 'ten_tai_khoan nap tien'}</strong></p>
      </div>`;
  }
}

// ================== ADMIN PANEL ==================
function openAdminPanel() {
  const pass = prompt("Xác nhận mật khẩu Admin:");
  if (pass === ADMIN_PASSWORD) {
    document.getElementById("adminModal").classList.remove("hidden");
    renderUserList();
    renderProductList();
    document.getElementById("qrPreview").src = qr;
  } else if (pass !== null) {
    alert("Mật khẩu sai!");
  }
}

function closeAdmin() {
  document.getElementById("adminModal").classList.add("hidden");
}

// ----- User -----
function renderUserList() {
  const list = document.getElementById("userList");
  let html = "";
  users.forEach((user, i) => {
    if (user.u === "admin") return;
    html += `
      <div class="user-list-item">
        <div>
          <strong style="color:#fecaca;">${user.u}</strong><br>
          <span style="color:#fda4af;">Số dư: ${Number(user.balance).toLocaleString('vi-VN')}đ</span>
        </div>
        <div style="display:flex;gap:10px;flex-wrap:wrap;">
          <input type="number" id="amount_${i}" placeholder="Số tiền" style="width:120px;">
          <button class="action-btn" style="padding:8px 14px;font-size:0.9rem;" onclick="changeBalance(${i}, true)">+ Tiền</button>
          <button class="action-btn" style="background:#991b1b;padding:8px 14px;font-size:0.9rem;" onclick="changeBalance(${i}, false)">- Tiền</button>
          <button class="delete-btn" onclick="deleteUser(${i})">Xóa</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html || "<p style='text-align:center;color:#fda4af;'>Chưa có người dùng nào</p>";
}

function changeBalance(index, isAdd) {
  const amountInput = document.getElementById(`amount_${index}`);
  const amount = Number(amountInput.value);
  if (!amount || amount <= 0) return alert("Vui lòng nhập số tiền hợp lệ!");

  if (confirm(`Xác nhận ${isAdd ? "cộng" : "trừ"} ${amount.toLocaleString('vi-VN')}đ cho user này?`)) {
    showLoading();
    setTimeout(() => {
      if (isAdd) users[index].balance += amount;
      else users[index].balance = Math.max(0, users[index].balance - amount);
      storage.setItem("users", JSON.stringify(users));
      if (currentUser && currentUser.u === users[index].u) {
        currentUser.balance = users[index].balance;
        storage.setItem("currentUser", JSON.stringify(currentUser));
      }
      renderUserList();
      render();
      hideLoading();
    }, 600);
  }
}

function deleteUser(index) {
  if (confirm("Xóa người dùng này vĩnh viễn?")) {
    showLoading();
    setTimeout(() => {
      if (users[index].u === currentUser?.u) logout();
      users.splice(index, 1);
      storage.setItem("users", JSON.stringify(users));
      renderUserList();
      hideLoading();
    }, 600);
  }
}

function addNewUser() {
  const name = document.getElementById("newUserName").value.trim();
  const pass = document.getElementById("newUserPass").value;
  const bal = Number(document.getElementById("newUserBalance").value) || 0;

  if (!name || name.length < 4) return alert("Tên đăng nhập ≥ 4 ký tự");
  if (!pass || pass.length < 6) return alert("Mật khẩu ≥ 6 ký tự");
  if (users.some(u => u.u === name)) return alert("Tên đăng nhập đã tồn tại!");

  showLoading();
  setTimeout(() => {
    users.push({ u: name, p: hash(pass), balance: bal });
    storage.setItem("users", JSON.stringify(users));
    document.getElementById("newUserName").value = "";
    document.getElementById("newUserPass").value = "";
    document.getElementById("newUserBalance").value = "";
    renderUserList();
    hideLoading();
    alert("Đã thêm user mới!");
  }, 800);
}

// ----- Sản phẩm -----
function renderProductList() {
  const list = document.getElementById("productList");
  let html = "";
  products.forEach((p, i) => {
    html += `
      <div class="product-item">
        <div>
          <strong style="color:#fecaca;">${p.name}</strong><br>
          <span style="color:#fda4af;">${p.desc} - ${Number(p.price).toLocaleString('vi-VN')}đ</span><br>
          <span style="color:#34d399;">Đã bán: ${Number(p.sold || 0).toLocaleString('vi-VN')}</span>
        </div>
        <div style="display:flex;gap:10px;">
          <input type="number" id="sold_${i}" value="${p.sold || 0}" placeholder="Số đã bán" style="width:110px;">
          <button class="action-btn" style="padding:8px 12px;font-size:0.9rem;" onclick="updateSold(${i})">Cập nhật</button>
          <button class="delete-btn" onclick="deleteProduct(${i})">Xóa</button>
        </div>
      </div>
    `;
  });
  list.innerHTML = html || "<p style='text-align:center;color:#fda4af;'>Chưa có sản phẩm nào</p>";
}

function updateSold(index) {
  const soldInput = document.getElementById(`sold_${index}`);
  const newSold = Number(soldInput.value);
  if (isNaN(newSold) || newSold < 0) return alert("Số lượng không hợp lệ!");

  showLoading();
  setTimeout(() => {
    products[index].sold = newSold;
    storage.setItem("products", JSON.stringify(products));
    renderProductList();
    render();
    hideLoading();
  }, 400);
}

function addNewProduct() {
  const name = document.getElementById("newProductName").value.trim();
  const desc = document.getElementById("newProductDesc").value.trim();
  const price = Number(document.getElementById("newProductPrice").value);

  if (!name) return alert("Vui lòng nhập tên sản phẩm");
  if (!price || price <= 0) return alert("Giá phải lớn hơn 0");

  showLoading();
  setTimeout(() => {
    products.push({ 
      name, 
      desc, 
      price, 
      sold: 0  // mặc định 0, admin có thể chỉnh sau
    });
    storage.setItem("products", JSON.stringify(products));
    document.getElementById("newProductName").value = "";
    document.getElementById("newProductDesc").value = "";
    document.getElementById("newProductPrice").value = "";
    renderProductList();
    render();
    hideLoading();
    alert("Đã thêm sản phẩm mới!");
  }, 800);
}

function deleteProduct(index) {
  if (confirm("Xóa sản phẩm này?")) {
    showLoading();
    setTimeout(() => {
      products.splice(index, 1);
      storage.setItem("products", JSON.stringify(products));
      renderProductList();
      render();
      hideLoading();
    }, 600);
  }
}

// ----- QR -----
function saveQR() {
  const note = document.getElementById("qn").value;
  const fileInput = document.getElementById("qrFileInput");

  showLoading();

  if (fileInput.files && fileInput.files[0]) {
    const reader = new FileReader();
    reader.onload = function(e) {
      qr = e.target.result;
      qrNote = note;
      storage.setItem("qr", qr);
      storage.setItem("qrNote", qrNote);
      document.getElementById("qrPreview").src = qr;
      render();
      hideLoading();
      alert("Đã cập nhật QR và ghi chú!");
    };
    reader.readAsDataURL(fileInput.files[0]);
  } else {
    qrNote = note;
    storage.setItem("qrNote", qrNote);
    render();
    hideLoading();
    alert("Đã cập nhật ghi chú!");
  }
}

// ================== CÁC HÀM KHÁC ==================
function saveNotice() { 
  showLoading();
  setTimeout(() => {
    notice = document.getElementById("n").value;
    storage.setItem("notice", notice);
    render();
    hideLoading();
    alert("Đã lưu thông báo!");
  }, 600);
}

function register() {
  const u = document.getElementById("ru").value.trim();
  const p = document.getElementById("rp").value;
  if (!u || !p) return alert("Điền đầy đủ!");
  if (u.length < 4) return alert("Tên đăng nhập ≥ 4 ký tự");
  if (p.length < 6) return alert("Mật khẩu ≥ 6 ký tự");
  if (users.find(x => x.u === u)) return alert("Tên đã tồn tại!");

  showLoading();
  setTimeout(() => {
    users.push({ u, p: hash(p), balance: 0 });
    storage.setItem("users", JSON.stringify(users));
    document.getElementById("regModal").classList.add("hidden");
    hideLoading();
    alert("Đăng ký thành công! Đăng nhập ngay nhé.");
    openLogin();
  }, 800);
}

function login() {
  const u = document.getElementById("lu").value.trim();
  const p = document.getElementById("lp").value;
  const user = users.find(x => x.u === u && x.p === hash(p));
  if (!user) return alert("Sai tên hoặc mật khẩu!");

  showLoading();
  setTimeout(() => {
    currentUser = user;
    storage.setItem("currentUser", JSON.stringify(user));
    document.getElementById("loginModal").classList.add("hidden");
    render();
    hideLoading();
  }, 800);
}

function logout() {
  showLoading();
  setTimeout(() => {
    currentUser = null;
    storage.removeItem("currentUser");
    render();
    hideLoading();
  }, 500);
}

function buy(i) {
  if (!currentUser) return alert("Đăng nhập trước nhé!");
  const price = Number(products[i].price);
  if (currentUser.balance < price) return alert("Không đủ tiền! Nạp thêm đi.");
  if (!confirm(`Mua "${products[i].name}" - ${price.toLocaleString('vi-VN')}đ ?`)) return;

  showLoading();
  setTimeout(() => {
    currentUser.balance -= price;
    const idx = users.findIndex(x => x.u === currentUser.u);
    users[idx].balance = currentUser.balance;
    // Tăng số lượng đã bán khi mua thật (tùy chọn)
    products[i].sold = (products[i].sold || 0) + 1;
    storage.setItem("users", JSON.stringify(users));
    storage.setItem("products", JSON.stringify(products));
    storage.setItem("currentUser", JSON.stringify(currentUser));
    render();
    hideLoading();
    alert("Mua thành công! Hàng sẽ gửi qua tin nhắn hoặc Telegram.");
  }, 1000);
}

function openLogin() { document.getElementById("loginModal").classList.remove("hidden"); }
function openRegister() { document.getElementById("regModal").classList.remove("hidden"); }

// ================== KHỞI TẠO DỮ LIỆU MẪU ==================
if (products.length === 0) {
  products = [
    { name: "Netflix Premium 1 Tháng", desc: "Full HD - Chính chủ", price: "159000", sold: 1247 },
    { name: "Spotify Premium 3 Tháng", desc: "Chia sẻ 6 người", price: "290000", sold: 893 },
    { name: "Canva Pro 1 Năm", desc: "Không giới hạn", price: "890000", sold: 456 }
  ];
  storage.setItem("products", JSON.stringify(products));
}

if (!users.some(u => u.u === "admin")) {
  users.push({ u: "admin", p: hash("admin123"), balance: 999999999 });
  storage.setItem("users", JSON.stringify(users));
}

render();
</script>
</body>
</html>