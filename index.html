<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>DIGITAL STORE - Shop Uy Tín</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  * { margin:0; padding:0; box-sizing:border-box; }
  body {
    font-family: 'Inter', system-ui, sans-serif;
    background: #0a0e17;
    color: #e2e8f0;
    min-height: 100vh;
    background: linear-gradient(135deg, #0a0e17 0%, #0f172a 100%);
  }

  .top {
    height: 70px;
    background: rgba(15, 23, 42, 0.9);
    backdrop-filter: blur(10px);
    display: flex;
    align-items: center;
    justify-content: space-between;
    padding: 0 30px;
    border-bottom: 1px solid rgba(59, 130, 246, 0.2);
    position: sticky;
    top: 0;
    z-index: 1000;
  }

  .logo {
    font-size: 1.6rem;
    font-weight: 800;
    background: linear-gradient(90deg, #38bdf8, #a5f3fc);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    letter-spacing: -0.5px;
  }

  .top-right button {
    background: linear-gradient(135deg, #38bdf8, #22d3ee);
    color: #0f172a;
    border: none;
    padding: 10px 20px;
    border-radius: 10px;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
    margin-left: 12px;
  }

  .top-right button:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(56, 189, 248, 0.5);
  }

  .wrap {
    max-width: 1400px;
    margin: 30px auto;
    padding: 0 20px;
    display: flex;
    gap: 30px;
    flex-wrap: wrap;
  }

  .sidebar {
    width: 280px;
    background: rgba(15, 23, 42, 0.7);
    backdrop-filter: blur(8px);
    border-radius: 20px;
    padding: 25px;
    border: 1px solid rgba(59, 130, 246, 0.15);
    height: fit-content;
  }

  .sidebar h3 {
    color: #38bdf8;
    font-size: 0.9rem;
    font-weight: 700;
    margin-bottom: 20px;
    text-transform: uppercase;
    letter-spacing: 2px;
  }

  .sidebar a {
    display: block;
    padding: 14px 18px;
    border-radius: 12px;
    margin-bottom: 10px;
    color: #cbd5e1;
    font-weight: 500;
    transition: all 0.3s ease;
    cursor: pointer;
  }

  .sidebar a:hover {
    background: rgba(59, 130, 246, 0.15);
    color: #38bdf8;
    transform: translateX(8px);
  }

  .content { flex: 1; min-width: 320px; }

  .notice {
    background: rgba(30, 41, 59, 0.6);
    border-left: 5px solid #38bdf8;
    padding: 16px 20px;
    border-radius: 12px;
    margin-bottom: 30px;
    font-size: 0.95rem;
    backdrop-filter: blur(4px);
  }

  .products {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 24px;
  }

  .card {
    background: rgba(15, 23, 42, 0.7);
    border-radius: 20px;
    padding: 24px;
    border: 1px solid rgba(59, 130, 246, 0.15);
    transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    backdrop-filter: blur(6px);
  }

  .card:hover {
    transform: translateY(-12px);
    box-shadow: 0 25px 50px -12px rgba(56, 189, 248, 0.25);
    border-color: #38bdf8;
  }

  .card h4 {
    color: #a5f3fc;
    font-size: 1.25rem;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .price {
    color: #4ade80;
    font-size: 1.5rem;
    font-weight: 800;
    margin: 16px 0;
  }

  .buy {
    background: linear-gradient(135deg, #38bdf8, #22d3ee);
    color: #0f172a;
    font-weight: 700;
    text-align: center;
    padding: 14px;
    border-radius: 12px;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 6px 20px rgba(56, 189, 248, 0.4);
  }

  .buy:hover {
    transform: scale(1.06);
    box-shadow: 0 12px 30px rgba(56, 189, 248, 0.6);
  }

  .box {
    background: rgba(15, 23, 42, 0.7);
    border-radius: 20px;
    padding: 25px;
    margin-bottom: 30px;
    border: 1px solid rgba(59, 130, 246, 0.15);
    backdrop-filter: blur(6px);
  }

  .box h3 {
    color: #38bdf8;
    margin-bottom: 20px;
    font-weight: 700;
  }

  input, textarea {
    width: 100%;
    padding: 14px 16px;
    border-radius: 12px;
    border: 1px solid rgba(59, 130, 246, 0.3);
    background: rgba(30, 41, 59, 0.6);
    color: white;
    margin-bottom: 16px;
    font-size: 1rem;
    transition: all 0.2s;
  }

  input:focus, textarea:focus {
    outline: none;
    border-color: #38bdf8;
    box-shadow: 0 0 0 3px rgba(56, 189, 248, 0.2);
  }

  button {
    background: linear-gradient(135deg, #38bdf8, #22d3ee);
    color: #0f172a;
    border: none;
    padding: 14px;
    border-radius: 12px;
    font-weight: 700;
    font-size: 1rem;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
    box-shadow: 0 4px 15px rgba(56, 189, 248, 0.3);
  }

  button:hover {
    transform: translateY(-2px);
    box-shadow: 0 10px 25px rgba(56, 189, 248, 0.5);
  }

  .modal {
    position: fixed;
    inset: 0;
    background: rgba(0,0,0,0.85);
    backdrop-filter: blur(8px);
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 9999;
  }

  .modal .box {
    width: 90%;
    max-width: 420px;
    background: rgba(15, 23, 42, 0.95);
    border-radius: 24px;
    padding: 32px;
    border: 1px solid rgba(56, 189, 248, 0.3);
    box-shadow: 0 25px 60px rgba(0,0,0,0.6);
  }

  .qr img {
    width: 100%;
    max-width: 260px;
    border-radius: 16px;
    margin: 20px auto;
    display: block;
    border: 3px solid #38bdf8;
    box-shadow: 0 10px 30px rgba(56, 189, 248, 0.3);
  }

  /* ===== LOADING ANIMATION ===== */
  #loadingOverlay {
    position: fixed;
    inset: 0;
    background: rgba(10, 14, 23, 0.95);
    backdrop-filter: blur(8px);
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    z-index: 99999;
    opacity: 0;
    visibility: hidden;
    transition: all 0.4s ease;
  }

  #loadingOverlay.active {
    opacity: 1;
    visibility: visible;
  }

  .spinner {
    width: 70px;
    height: 70px;
    border: 6px solid rgba(56, 189, 248, 0.2);
    border-top: 6px solid #38bdf8;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    box-shadow: 0 0 30px rgba(56, 189, 248, 0.6);
  }

  @keyframes spin {
    0% { transform: rotate(0deg); }
    100% { transform: rotate(360deg); }
  }

  .loading-text {
    margin-top: 25px;
    font-size: 1.1rem;
    font-weight: 600;
    color: #38bdf8;
    letter-spacing: 1px;
  }

  @media (max-width: 768px) {
    .wrap { flex-direction: column; }
    .sidebar { width: 100%; }
  }
</style>
</head>
<body>

<!-- LOADING OVERLAY -->
<div id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text">Đang xử lý...</div>
</div>

<div class="top">
  <div class="logo">DIGITAL STORE</div>
  <div class="top-right" id="topRight"></div>
</div>

<div class="wrap">
  <div class="sidebar">
    <h3>MENU</h3>
    <a onclick="view='shop';render()">Cửa hàng</a>
    <a onclick="view='nap';render()">Nạp tiền</a>
    <a onclick="openAdmin()">Admin Panel</a>
  </div>
  <div class="content" id="content"></div>
</div>

<!-- Modal Đăng nhập -->
<div class="modal hidden" id="loginModal">
  <div class="box">
    <h3>Đăng Nhập</h3>
    <input id="lu" placeholder="Tên đăng nhập">
    <input id="lp" type="password" placeholder="Mật khẩu">
    <button onclick="login()">Đăng Nhập</button>
  </div>
</div>

<!-- Modal Đăng ký -->
<div class="modal hidden" id="regModal">
  <div class="box">
    <h3>Tạo Tài Khoản</h3>
    <input id="ru" placeholder="Tên đăng nhập (≥4 ký tự)">
    <input id="rp" type="password" placeholder="Mật khẩu (≥6 ký tự)">
    <button onclick="register()">Tạo Tài Khoản</button>
  </div>
</div>

<script>
// Fix localStorage
function getStorage() {
  try { return localStorage; } catch(e) {
    return {
      data: {},
      getItem(k) { return this.data[k] || null; },
      setItem(k, v) { this.data[k] = v+''; },
      removeItem(k) { delete this.data[k]; }
    };
  }
}
const storage = getStorage();

// Loading functions
const loadingOverlay = document.getElementById("loadingOverlay");
function showLoading() {
  loadingOverlay.classList.add("active");
}
function hideLoading() {
  setTimeout(() => loadingOverlay.classList.remove("active"), 300); // delay nhẹ cho mượt
}

let users = JSON.parse(storage.getItem("users") || "[]");
let products = JSON.parse(storage.getItem("products") || "[]");
let notice = storage.getItem("notice") || "⚡ Shop uy tín - Giao dịch an toàn 100%";
let qr = storage.getItem("qr") || "https://i.imgur.com/9Z7Y9Kb.png";
let qrNote = storage.getItem("qrNote") || "Chuyển khoản đúng nội dung → tiền tự động cộng trong 1-5 phút";
let currentUser = JSON.parse(storage.getItem("currentUser") || "null");
let view = "shop";

function hash(str) {
  let h = 0;
  for(let i = 0; i < str.length; i++) h = (h << 5) - h + str.charCodeAt(i);
  return h.toString(36);
}

function render() {
  document.getElementById("topRight").innerHTML = currentUser 
    ? `<span>${currentUser.u} • ${Number(currentUser.balance).toLocaleString('vi-VN')}đ</span>
       <button onclick="logout()">Thoát</button>`
    : `<button onclick="openLogin()">Đăng nhập</button>
       <button onclick="openRegister()">Đăng ký</button>`;

  const content = document.getElementById("content");

  if(view === "shop") {
    content.innerHTML = `
      <div class="notice">${notice}</div>
      <div class="products">
        ${products.length ? products.map((p,i)=>`
          <div class="card">
            <h4>${p.name}</h4>
            <div style="color:#94a3b8;margin:8px 0;">${p.desc}</div>
            <div class="price">${Number(p.price).toLocaleString('vi-VN')}đ</div>
            <div class="buy" onclick="buy(${i})">MUA NGAY</div>
          </div>
        `).join("") : "<div style='text-align:center;padding:60px 0;color:#64748b;'>Chưa có sản phẩm nào.<br>Vào Admin để thêm ngay!</div>"}
      </div>`;
  }

  if(view === "nap") {
    content.innerHTML = `
      <div class="box" style="text-align:center">
        <h3>Nạp Tiền</h3>
        ${qr ? `<img src="${qr}" alt="QR Code">` : "<p style='color:#f87171'>Chưa có QR. Vào Admin để thêm.</p>"}
        <p style="margin:20px 0;color:#cbd5e1;">${qrNote}</p>
        <p style="color:#4ade80;font-weight:600;">Tiền sẽ tự động cộng sau khi chuyển khoản!</p>
      </div>`;
  }

  if(view === "admin") {
    content.innerHTML = `
      <div class="box">
        <h3>Thông Báo Trang Chủ</h3>
        <textarea id="n" rows="3">${notice}</textarea>
        <button onclick="saveNotice()">Lưu</button>
      </div>
      <div class="box">
        <h3>QR Code Nạp Tiền</h3>
        <input id="q" value="${qr}" placeholder="Dán link ảnh QR">
        <input id="qn" value="${qrNote}" placeholder="Ghi chú dưới QR">
        <button onclick="saveQR()">Lưu QR</button>
      </div>
      <div class="box">
        <h3>Thêm Sản Phẩm Mới</h3>
        <input id="pn" placeholder="Tên sản phẩm">
        <input id="pd" placeholder="Mô tả chi tiết">
        <input id="pp" type="number" placeholder="Giá (ví dụ: 150000)">
        <button onclick="addProduct()">Thêm Sản Phẩm</button>
      </div>
      <div class="box">
        <h3>Danh Sách Sản Phẩm</h3>
        ${products.map((p,i)=>`
          <div style="display:flex;justify-content:space-between;align-items:center;padding:12px;background:rgba(30,41,59,0.5);border-radius:12px;margin:10px 0;">
            <div>
              <strong style="color:#a5f3fc">${p.name}</strong><br>
              <span style="color:#94a3b8">${p.desc} • ${Number(p.price).toLocaleString('vi-VN')}đ</span>
            </div>
            <button onclick="del(${i})" style="background:#ef4444;padding:8px 16px;font-size:0.9rem;">Xóa</button>
          </div>
        `).join("") || "<p style='text-align:center;color:#64748b;'>Chưa có sản phẩm nào.</p>"}
      </div>`;
  }
}

// Các hàm lưu + loading
function saveNotice() { 
  showLoading(); 
  setTimeout(() => {
    notice = document.getElementById("n").value; 
    storage.setItem("notice", notice); 
    render(); 
    hideLoading();
    alert("Đã cập nhật thông báo!");
  }, 800);
}

function saveQR() { 
  showLoading(); 
  setTimeout(() => {
    qr = document.getElementById("q").value; 
    qrNote = document.getElementById("qn").value; 
    storage.setItem("qr", qr); 
    storage.setItem("qrNote", qrNote); 
    render(); 
    hideLoading();
    alert("Đã cập nhật QR!");
  }, 800);
}

function addProduct() {
  const n = document.getElementById("pn"), d = document.getElementById("pd"), p = document.getElementById("pp");
  if (!n.value || !d.value || !p.value || isNaN(p.value)) return alert("Vui lòng điền đầy đủ và đúng định dạng!");
  showLoading();
  setTimeout(() => {
    products.push({ name: n.value, desc: d.value, price: p.value });
    storage.setItem("products", JSON.stringify(products));
    n.value = d.value = p.value = "";
    render();
    hideLoading();
    alert("Thêm sản phẩm thành công!");
  }, 800);
}

function del(i) {
  if (confirm("Bạn có chắc muốn xóa sản phẩm này?")) {
    showLoading();
    setTimeout(() => {
      products.splice(i, 1);
      storage.setItem("products", JSON.stringify(products));
      render();
      hideLoading();
    }, 600);
  }
}

function openAdmin() {
  const pass = prompt("Mật khẩu Admin:");
  if (pass === "admin123") { view = "admin"; render(); }
  else if (pass !== null) alert("Mật khẩu sai!");
}

function register() {
  const u = document.getElementById("ru").value.trim();
  const p = document.getElementById("rp").value;
  if (!u || !p) return alert("Vui lòng điền đầy đủ!");
  if (u.length < 4) return alert("Tên đăng nhập phải ≥ 4 ký tự");
  if (p.length < 6) return alert("Mật khẩu phải ≥ 6 ký tự");
  if (users.find(x => x.u === u)) return alert("Tên đăng nhập đã tồn tại!");
  
  showLoading();
  setTimeout(() => {
    users.push({ u, p: hash(p), balance: 0 });
    storage.setItem("users", JSON.stringify(users));
    hideLoading();
    alert("Đăng ký thành công! Hãy đăng nhập ngay.");
    document.getElementById("regModal").classList.add("hidden");
  }, 1000);
}

function login() {
  const u = document.getElementById("lu").value.trim();
  const p = document.getElementById("lp").value;
  const user = users.find(x => x.u === u && x.p === hash(p));
  if (!user) return alert("Sai tên đăng nhập hoặc mật khẩu!");
  
  showLoading();
  setTimeout(() => {
    currentUser = user;
    storage.setItem("currentUser", JSON.stringify(user));
    document.getElementById("loginModal").classList.add("hidden");
    render();
    hideLoading();
  }, 1000);
}

function logout() {
  showLoading();
  setTimeout(() => {
    currentUser = null;
    storage.removeItem("currentUser");
    render();
    hideLoading();
  }, 600);
}

function buy(i) {
  if (!currentUser) return alert("Vui lòng đăng nhập trước!");
  const price = Number(products[i].price);
  if (currentUser.balance < price) return alert("Số dư không đủ! Vui lòng nạp thêm.");
  if (!confirm(`Xác nhận mua "${products[i].name}" với giá ${price.toLocaleString('vi-VN')}đ ?`)) return;
  
  showLoading();
  setTimeout(() => {
    currentUser.balance -= price;
    const idx = users.findIndex(x => x.u === currentUser.u);
    if (idx !== -1) users[idx].balance = currentUser.balance;
    storage.setItem("users", JSON.stringify(users));
    storage.setItem("currentUser", JSON.stringify(currentUser));
    render();
    hideLoading();
    alert("Mua hàng thành công! Tài khoản/sản phẩm sẽ được gửi qua tin nhắn.");
  }, 1200);
}

function openLogin() { document.getElementById("loginModal").classList.remove("hidden"); }
function openRegister() { document.getElementById("regModal").classList.remove("hidden"); }

window.onclick = e => {
  if (e.target.classList.contains("modal")) e.target.classList.add("hidden");
};

// Dữ liệu mẫu
if (products.length === 0) {
  products = [
    { name: "Netflix Premium 1 Tháng", desc: "Tài khoản chính chủ - Full HD", price: "159000" },
    { name: "Spotify Premium 3 Tháng", desc: "Nghe không quảng cáo - Chia sẻ 6 người", price: "290000" },
    { name: "Windows 11 Pro Key", desc: "Key bản quyền vĩnh viễn", price: "690000" },
    { name: "Canva Pro 1 Năm", desc: "Tài khoản cá nhân - Không giới hạn", price: "890000" }
  ];
  storage.setItem("products", JSON.stringify(products));
}

render();
</script>
</body>
</html>